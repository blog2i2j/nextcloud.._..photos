{"version":3,"file":"FetchCollectionContentMixin-D1PObkyx.chunk.mjs","sources":["../src/mixins/FetchCollectionContentMixin.ts"],"sourcesContent":["/**\n * SPDX-FileCopyrightText: 2022 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport type { WebDAVClient } from 'webdav'\nimport { defineComponent } from 'vue'\n\nimport { showError } from '@nextcloud/dialogs'\nimport type { File } from '@nextcloud/files'\nimport { translate as t } from '@nextcloud/l10n'\n\nimport AbortControllerMixin from './AbortControllerMixin.js'\nimport { fetchCollection, fetchCollectionFiles, type Collection } from '../services/collectionFetcher.js'\nimport logger from '../services/logger.js'\nimport SemaphoreWithPriority from '../utils/semaphoreWithPriority.js'\nimport { isAxiosError } from 'axios'\n\nexport default defineComponent({\n\tname: 'FetchCollectionContentMixin',\n\n\tdata() {\n\t\treturn {\n\t\t\tfetchSemaphore: new SemaphoreWithPriority(1),\n\t\t\tloadingCollection: false,\n\t\t\tloadingCollectionFiles: false,\n\t\t\terrorFetchingCollection: null as null|number|Error|unknown,\n\t\t\terrorFetchingCollectionFiles: null as null|number|Error|unknown,\n\t\t}\n\t},\n\n\tmixins: [\n\t\tAbortControllerMixin,\n\t],\n\n\tmethods: {\n\t\tasync fetchCollection(collectionFileName: string, extraProps: string[], client?: WebDAVClient): Promise<Collection|null> {\n\t\t\tif (this.loadingCollection) {\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tthis.loadingCollection = true\n\t\t\t\tthis.errorFetchingCollection = null\n\n\t\t\t\tconst collection = await fetchCollection(collectionFileName, { signal: this.abortController.signal }, extraProps, client)\n\t\t\t\tthis.$store.dispatch('addCollections', { collections: [collection] })\n\t\t\t\treturn collection\n\t\t\t} catch (error) {\n\t\t\t\tif (isAxiosError(error) && error.response?.status === 404) {\n\t\t\t\t\tthis.errorFetchingCollection = 404\n\t\t\t\t\treturn null\n\t\t\t\t}\n\n\t\t\t\tthis.errorFetchingCollection = error\n\t\t\t\tlogger.error('[PublicCollectionContent] Error fetching collection', { error })\n\t\t\t\tshowError(t('photos', 'Failed to fetch collection.'))\n\t\t\t} finally {\n\t\t\t\tthis.loadingCollection = false\n\t\t\t}\n\n\t\t\treturn null\n\t\t},\n\n\t\tasync fetchCollectionFiles(collectionFileName: string, extraProps?: string[], client?: WebDAVClient): Promise<File[]> {\n\t\t\tif (this.loadingCollectionFiles) {\n\t\t\t\treturn []\n\t\t\t}\n\n\t\t\tconst fetchSemaphoreSymbol = await this.fetchSemaphore.acquire()\n\n\t\t\ttry {\n\t\t\t\tthis.errorFetchingCollectionFiles = null\n\t\t\t\tthis.loadingCollectionFiles = true\n\n\t\t\t\tconst fetchedFiles = await fetchCollectionFiles(collectionFileName, { signal: this.abortController.signal }, extraProps, client)\n\t\t\t\tconst fileIds = fetchedFiles.map(file => file.fileid?.toString())\n\n\t\t\t\tthis.$store.dispatch('appendFiles', fetchedFiles)\n\n\t\t\t\tif (fetchedFiles.length > 0) {\n\t\t\t\t\tawait this.$store.commit('setCollectionFiles', { collectionFileName, fileIds })\n\t\t\t\t}\n\n\t\t\t\treturn fetchedFiles\n\t\t\t} catch (error) {\n\t\t\t\tif (isAxiosError(error) && error.response?.status === 404) {\n\t\t\t\t\tthis.errorFetchingCollectionFiles = 404\n\t\t\t\t\treturn []\n\t\t\t\t}\n\n\t\t\t\tthis.errorFetchingCollectionFiles = error\n\n\t\t\t\tshowError(t('photos', 'Failed to fetch collections list.'))\n\t\t\t\tlogger.error('[PublicCollectionContent] Error fetching collection files', { error })\n\t\t\t} finally {\n\t\t\t\tthis.loadingCollectionFiles = false\n\t\t\t\tthis.fetchSemaphore.release(fetchSemaphoreSymbol)\n\t\t\t}\n\n\t\t\treturn []\n\t\t},\n\t},\n})\n"],"names":["FetchCollectionContentMixin","defineComponent","SemaphoreWithPriority","AbortControllerMixin","collectionFileName","extraProps","client","collection","fetchCollection","error","isAxiosError","logger","showError","t","fetchSemaphoreSymbol","fetchedFiles","fetchCollectionFiles","fileIds","file"],"mappings":"oQAkBA,MAAAA,EAAeC,EAAgB,CAC9B,KAAM,8BAEN,MAAO,CACC,MAAA,CACN,eAAgB,IAAIC,EAAsB,CAAC,EAC3C,kBAAmB,GACnB,uBAAwB,GACxB,wBAAyB,KACzB,6BAA8B,IAC/B,CACD,EAEA,OAAQ,CACPC,CACD,EAEA,QAAS,CACR,MAAM,gBAAgBC,EAA4BC,EAAsBC,EAAiD,CACxH,GAAI,KAAK,kBACD,OAAA,KAGJ,GAAA,CACH,KAAK,kBAAoB,GACzB,KAAK,wBAA0B,KAEzB,MAAAC,EAAa,MAAMC,EAAgBJ,EAAoB,CAAE,OAAQ,KAAK,gBAAgB,QAAUC,EAAYC,CAAM,EACnH,OAAA,KAAA,OAAO,SAAS,iBAAkB,CAAE,YAAa,CAACC,CAAU,EAAG,EAC7DA,QACCE,EAAO,CACf,GAAIC,EAAaD,CAAK,GAAKA,EAAM,UAAU,SAAW,IACrD,OAAK,KAAA,wBAA0B,IACxB,KAGR,KAAK,wBAA0BA,EAC/BE,EAAO,MAAM,sDAAuD,CAAE,MAAAF,CAAA,CAAO,EACnEG,EAAAC,EAAE,SAAU,6BAA6B,CAAC,CAAA,QAAA,CAEpD,KAAK,kBAAoB,EAAA,CAGnB,OAAA,IACR,EAEA,MAAM,qBAAqBT,EAA4BC,EAAuBC,EAAwC,CACrH,GAAI,KAAK,uBACR,MAAO,CAAC,EAGT,MAAMQ,EAAuB,MAAM,KAAK,eAAe,QAAQ,EAE3D,GAAA,CACH,KAAK,6BAA+B,KACpC,KAAK,uBAAyB,GAExB,MAAAC,EAAe,MAAMC,EAAqBZ,EAAoB,CAAE,OAAQ,KAAK,gBAAgB,QAAUC,EAAYC,CAAM,EACzHW,EAAUF,EAAa,OAAYG,EAAK,QAAQ,UAAU,EAE3D,OAAA,KAAA,OAAO,SAAS,cAAeH,CAAY,EAE5CA,EAAa,OAAS,GACzB,MAAM,KAAK,OAAO,OAAO,qBAAsB,CAAE,mBAAAX,EAAoB,QAAAa,EAAS,EAGxEF,QACCN,EAAO,CACf,GAAIC,EAAaD,CAAK,GAAKA,EAAM,UAAU,SAAW,IACrD,OAAA,KAAK,6BAA+B,IAC7B,CAAC,EAGT,KAAK,6BAA+BA,EAE1BG,EAAAC,EAAE,SAAU,mCAAmC,CAAC,EAC1DF,EAAO,MAAM,4DAA6D,CAAE,MAAAF,CAAA,CAAO,CAAA,SAEnF,KAAK,uBAAyB,GACzB,KAAA,eAAe,QAAQK,CAAoB,CAAA,CAGjD,MAAO,CAAC,CAAA,CACT,CAEF,CAAC"}