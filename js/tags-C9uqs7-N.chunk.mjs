import{H as q,aG as B,L as R,N as U,ag as G,a1 as H,D as A,V as d,r as w,_ as J,i as E,e as S,p as K,o as Q,aE as W}from"./vendor-DOPpmdjb.chunk.mjs";import{r as X,h as $,g as j,a as Y,l as _,s as I,i as N,n as T,k as Z,o as tt,m as et}from"./photos-main.mjs";import"./photos-sidebar.mjs";import{g as st,k as at}from"./icons-Ba8uv1cK.chunk.mjs";var C={exports:{}},it=C.exports,L;function ot(){return L||(L=1,function(t){(function(e){if(typeof s!="function"){var s=function(i){return i};s.nonNative=!0}const o=s("plaintext"),h=s("html"),u=s("comment"),F=/<(\w*)>/g,M=/<\/?([^\s\/>]+)/;function v(i,a,l){i=i||"",a=a||[],l=l||"";let p=x(a,l);return k(i,p)}function V(i,a){i=i||[],a=a||"";let l=x(i,a);return function(p){return k(p||"",l)}}v.init_streaming_mode=V;function x(i,a){return i=z(i),{allowable_tags:i,tag_replacement:a,state:o,tag_buffer:"",depth:0,in_quote_char:""}}function k(i,a){if(typeof i!="string")throw new TypeError("'html' parameter must be a string");let l=a.allowable_tags,p=a.tag_replacement,c=a.state,n=a.tag_buffer,m=a.depth,g=a.in_quote_char,f="";for(let y=0,P=i.length;y<P;y++){let r=i[y];if(c===o)switch(r){case"<":c=h,n+=r;break;default:f+=r;break}else if(c===h)switch(r){case"<":if(g)break;m++;break;case">":if(g)break;if(m){m--;break}g="",c=o,n+=">",l.has(D(n))?f+=n:f+=p,n="";break;case'"':case"'":r===g?g="":g=g||r,n+=r;break;case"-":n==="<!-"&&(c=u),n+=r;break;case" ":case`
`:if(n==="<"){c=o,f+="< ",n="";break}n+=r;break;default:n+=r;break}else if(c===u)switch(r){case">":n.slice(-2)=="--"&&(c=o),n="";break;default:n+=r;break}}return a.state=c,a.tag_buffer=n,a.depth=m,a.in_quote_char=g,f}function z(i){let a=new Set;if(typeof i=="string"){let l;for(;l=F.exec(i);)a.add(l[1])}else!s.nonNative&&typeof i[s.iterator]=="function"?a=new Set(i):typeof i.forEach=="function"&&i.forEach(a.add,a);return a}function D(i){let a=M.exec(i);return a?a[1].toLowerCase():null}t.exports?t.exports=v:e.striptags=v})(it)}(C)),C.exports}ot(),q(B),{...U.props,placeholder:R("Select a tag")};const Et=G("photos","systemtags",!1);var b,O;function St(){if(O)return b;O=1;var t=H(),e=t("toStringTag"),s={};return s[e]="z",b=String(s)==="[object z]",b}async function nt(t,e={}){return e=Object.assign({headers:{method:"REPORT"},data:`<?xml version="1.0"?>
			<oc:filter-files
				xmlns:d="DAV:"
				xmlns:oc="http://owncloud.org/ns"
				xmlns:nc="http://nextcloud.org/ns"
				xmlns:ocs="http://open-collaboration-services.org/ns">
				<d:prop>
					${X()}
				</d:prop>
				<oc:filter-rules>
					<oc:systemtag>${t}</oc:systemtag>
				</oc:filter-rules>
			</oc:filter-files>`,details:!0},e),(await $.getDirectoryContents(A,e)).data.map(s=>j(s)).filter(s=>s.mime&&Y.indexOf(s.mime)!==-1).map(s=>Object.assign({},s,{filename:s.filename.replace(A,"")}))}async function rt(t,e={}){return(await $.getDirectoryContents("/systemtags-assigned/image",Object.assign({},{data:`<?xml version="1.0"?>
			<d:propfind  xmlns:d="DAV:"
				xmlns:oc="http://owncloud.org/ns" xmlns:nc="http://nextcloud.org/ns">
				<d:prop>
					<oc:id />
					<oc:display-name />
					<oc:user-visible />
					<oc:user-assignable />
					<oc:can-assign />
					<nc:files-assigned/>
					<nc:reference-fileid/>
				</d:prop>
			</d:propfind>`,details:!0},e))).data.map(s=>j(s))}const lt={tags:{},names:{}},ct={updateTags(t,e){e.length>0&&e.sort((s,o)=>I(s,o,"displayName")).forEach(s=>{d.set(t.tags,s.id,s),d.set(t.names,s.displayName,s.id)})},removeTag(t,{id:e}){d.delete(t.names,t.tags[e].displayName),d.delete(t.tags,e)},updateTag(t,{id:e,files:s}){if(s.length===0){d.delete(t.names,t.tags[e].displayName),d.delete(t.tags,e);return}const o=s.sort((h,u)=>I(h,u,"filesAssigned"));_.debug(`Overwrite list, id: ${e}`,{list:o}),d.set(t.tags[e],"files",o.map(h=>h.fileid))}},gt={tags:t=>t.tags,tagsNames:t=>t.names,tag:t=>e=>t.tags[e],tagId:t=>e=>t.names[e]},dt={updateTags(t,e){t.commit("updateTags",e)},updateTag(t,{id:e,files:s}){s.length===0&&t.commit("removeTag",{id:e}),t.commit("updateTag",{id:e,files:s})},async fetchTagFiles(t,{id:e,signal:s}){try{const o=await nt(e,{signal:s});await t.dispatch("updateTag",{id:e,files:o}),await t.dispatch("appendFiles",o)}catch(o){o.response&&o.response.status?_.error(`Failed to get tag content, id: ${e}`,{error:o}):_.error(o)}},async fetchAllTags(t,{signal:e}){const s=await rt("",{signal:e});await t.dispatch("updateTags",s)}},$t={state:lt,mutations:ct,getters:gt,actions:dt},ht={name:"TagCover",components:{ImageMultipleIcon:st},mixins:[N],props:{tag:{type:Object,required:!0}},data(){return{loadCover:!1,observer:null}},computed:{...w(["files","tags"]),coverUrl(){return this.loadCover?J(`/core/preview?fileId=${this.tag.referenceFileid}&x=512&y=512&forceIcon=0&a=1`):""},count(){return this.tag.filesAssigned}},watch:{loadCover(){this.tag.filesAssigned||this.$store.dispatch("fetchTagFiles",{id:this.tag.id,signal:this.abortController.signal})}},mounted(){this.observer=new IntersectionObserver(t=>{t[0].isIntersecting&&(this.loadCover=!0,this.observer.disconnect())}),this.observer.observe(this.$el)}};var pt=function(){var t=this,e=t._self._c;return e("router-link",{staticClass:"tag-cover",attrs:{to:`/tags/${t.tag.displayName}`}},[t.tag.filesAssigned!==0?e("img",{staticClass:"tag-cover__image",attrs:{src:t.coverUrl}}):e("div",{staticClass:"tag-cover__image tag-cover__image--placeholder"},[e("ImageMultipleIcon",{attrs:{size:128}})],1),e("div",{staticClass:"tag-cover__details"},[e("div",{staticClass:"tag-cover__details__first-line"},[e("h3",{staticClass:"tag-cover__details__name"},[t._v(" "+t._s(t.t("recognize",t.tag.displayName))+" ")])]),e("div",{staticClass:"tag-cover__details__second-line"},[t._v(" "+t._s(t.n("photos","%n photo","%n photos",t.count))+" ")])])])},ft=[],ut=T(ht,pt,ft,!1,null,"3f8c5577");const mt=ut.exports,_t={name:"Tags",components:{TagCover:mt,NcLoadingIcon:S,NcEmptyContent:E},mixins:[N],data(){return{error:null,loading:!1,showTags:!1}},computed:{...w(["files","tags","tagsNames"]),tagsList(){return Object.keys(this.tagsNames).map(t=>this.tags[this.tagsNames[t]]).filter(t=>t&&t.id)},popularTags(){return Object.keys(this.tagsNames).filter(t=>this.tags[this.tagsNames[t]].filesAssigned>50).sort((t,e)=>(this.tags[this.tagsNames[e]].filesAssigned||this.tagCounts[e])-(this.tags[this.tagsNames[t]].filesAssigned||this.tagCounts[t])).slice(0,9).map(t=>this.tags[this.tagsNames[t]])}},async beforeMount(){await this.fetchRootContent()},methods:{async fetchRootContent(){OCA.Viewer.close(),this.error=null;try{this.tagsList.length||(this.loading=!0,await this.$store.dispatch("fetchAllTags",{signal:this.abortController.signal}))}catch(t){_.error(t),this.error=!0}finally{this.loading=!1}}}};var vt=function(){var t=this,e=t._self._c;return e("div",[t.error?e("NcEmptyContent",{attrs:{name:t.t("photos","An error occurred")}}):t._e(),!t.loading&&t.tagsList.length===0?e("NcEmptyContent",{attrs:{name:t.t("photos","No tags yet"),description:t.t("photos","Photos with tags will show up here")}}):t._e(),t.loading?e("NcLoadingIcon",{staticClass:"loader"}):e("div",{staticClass:"container"},[t.popularTags.length?e("h2",[t._v(" "+t._s(t.t("photos","Popular tags"))+" ")]):t._e(),e("div",{staticClass:"popular-tags"},t._l(t.popularTags,function(s){return e("TagCover",{key:s.id,attrs:{tag:s}})}),1),t.tagsList.length?e("h2",[t._v(" "+t._s(t.t("photos","All tags"))+" ")]):t._e(),e("div",{staticClass:"tags"},t._l(t.tagsList,function(s){return e("TagCover",{key:s.id,attrs:{tag:s}})}),1)])],1)},yt=[],bt=T(_t,vt,yt,!1,null,"97ef01c0");const Ct=bt.exports,jt=Object.freeze(Object.defineProperty({__proto__:null,default:Ct},Symbol.toStringTag,{value:"Module"})),wt={name:"TagContent",components:{File:et,FilesListViewer:tt,NcEmptyContent:E,NcActions:Q,NcActionButton:K,NcLoadingIcon:S,ArrowLeft:at},mixins:[Z,N],props:{path:{type:String,default:""}},setup(){return{isMobile:W()}},data(){return{error:null,loading:!1,appContent:document.getElementById("app-content-vue")}},computed:{...w(["files","tags","tagsNames"]),tagId(){return this.$store.getters.tagId(this.path)},tag(){return this.tags[this.tagId]},fileIds(){return this.tag?.files??[]},isEmpty(){return this.fileIds.length===0}},watch:{async path(){this.fetchContent()}},async beforeMount(){this.fetchContent()},methods:{async fetchContent(){OCA.Viewer.close(),this.loading=!0,this.error=null;try{this.tags[this.tagId]||await this.$store.dispatch("fetchAllTags",{signal:this.abortController.signal}),this.tag&&!this.tag.files&&await this.$store.dispatch("fetchTagFiles",{id:this.tagId,signal:this.abortController.signal})}catch(t){logger.error(t),this.error=!0}finally{this.loading=!1}},openViewer(t){const e=this.files[t];OCA.Viewer.open({path:e.filename,list:this.fileIds.map(s=>this.files[s]),loadMore:e.loadMore?async()=>await e.loadMore(!0):()=>[],canLoop:e.canLoop})}}};var Nt=function(){var t=this,e=t._self._c;return t.error?e("NcEmptyContent",{attrs:{name:t.t("photos","An error occurred")}}):t.loading?e("NcLoadingIcon",{staticClass:"loader"}):e("div",[e("div",{staticClass:"photos-navigation"},[e("NcActions",{staticClass:"photos-navigation__back"},[e("NcActionButton",{on:{click:function(s){return t.$router.push({name:"tags"})}},scopedSlots:t._u([{key:"icon",fn:function(){return[e("ArrowLeft")]},proxy:!0}])},[t._v(" "+t._s(t.t("photos","Back to tags overview"))+" ")])],1),e("h2",{staticClass:"photos-navigation__title"},[t._v(" "+t._s(t.path)+" ")])],1),e("div",{staticClass:"heading-subline"},[t._v(" "+t._s(t.n("photos","%n photo","%n photos",t.fileIds.length))+" ")]),t.isEmpty?e("NcEmptyContent",{attrs:{name:t.t("photos","No photos with this tag yet")}}):t._e(),e("FilesListViewer",{staticClass:"tag__photos",attrs:{"container-element":t.appContent,"file-ids":t.fileIds,"base-height":t.isMobile?120:200,loading:t.loading},scopedSlots:t._u([{key:"default",fn:function({file:s,distance:o}){return e("File",{attrs:{file:t.files[s.id],"allow-selection":!0,selected:t.selection[s.id]===!0,distance:o},on:{click:t.openViewer,"select-toggled":t.onFileSelectToggle}})}}])})],1)},Tt=[],xt=T(wt,Nt,Tt,!1,null,"29375ea7");const kt=xt.exports,Ft=Object.freeze(Object.defineProperty({__proto__:null,default:kt},Symbol.toStringTag,{value:"Module"}));export{jt as T,$t as a,Ft as b,St as r,Et as s};
//# sourceMappingURL=tags-C9uqs7-N.chunk.mjs.map
