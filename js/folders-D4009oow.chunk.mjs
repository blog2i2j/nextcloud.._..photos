import{z as g,t as F,b as v,V as a,g as p,_ as y,r as c,B as w,C as _,e as C,i as b,D as S,F as L,E as I,G as $}from"./vendor-DOPpmdjb.chunk.mjs";import{b as j,p as f}from"./icons-Ba8uv1cK.chunk.mjs";import"./photos-sidebar.mjs";import"./tags-C9uqs7-N.chunk.mjs";import{n as d,s as h,i as u,l as n,G as x,H as P,p as N,q as E,a as T}from"./photos-main.mjs";import{g as m}from"./albums-CeDjJMgY.chunk.mjs";const k=g({name:"PhotosFolder",components:{NcButton:v,Folder:f,Close:j},props:{path:{type:String,required:!0},canDelete:{type:Boolean,default:!1},rootFolderLabel:{type:String,required:!0},rootFolderIcon:{type:Object,required:!0}},emits:["remove-folder"],computed:{folderName(){return this.path==="/"?this.rootFolderLabel:this.path.split("/").pop()},subname(){switch((this.path.match(/\//g)??[]).length){case 1:return"";case 2:return this.path.split("/").splice(0,2).join("/");default:return this.path.split("/").splice(0,3).join("/")}}},methods:{emitRemoveSourceFolder(){this.$emit("remove-folder")},t:F}});var O=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{staticClass:"folder"},[e.path==="/"?i(e.rootFolderIcon,{tag:"component"}):i("Folder"),i("span",{staticClass:"folder__info"},[i("div",{staticClass:"folder__path"},[e._v(e._s(e.folderName))]),e.subname!==""?i("div",[e._v(" "+e._s(e.subname)+" ")]):e._e()]),e.canDelete?i("NcButton",{attrs:{type:"tertiary","aria-label":e.t("photos","Delete source directory")},on:{click:e.emitRemoveSourceFolder},scopedSlots:e._u([{key:"icon",fn:function(){return[i("Close",{attrs:{size:20}})]},proxy:!0}],null,!1,2121748766)}):e._e()],1)},q=[],z=d(k,O,q,!1,null,"b29d3ff4");const ne=z.exports,U={paths:{},folders:{}},A={updateFolders(e,{fileid:i,files:r}){if(r.length>0){const o=r.sort((s,l)=>h(s,l,"lastmod")).filter(s=>s.fileid>=0);a.set(e.folders,i,o.map(s=>s.fileid))}else a.set(e.folders,i,[])},addPath(e,{path:i,fileid:r}){r>=0&&a.set(e.paths,i,r)},addFilesToFolder(e,{fileid:i,files:r}){if(i>=0&&r.length>0){const o=r.sort((s,l)=>h(s,l,"lastmod")).filter(s=>s.fileid>=0).map(s=>s.fileid);a.set(e.folders,i,[...o,...e.folders[i]])}}},D={folders:e=>e.folders,folder:e=>i=>e.folders[i],folderId:e=>i=>e.paths[i]},R={updateFolders(e,{fileid:i,files:r,folders:o}){e.commit("updateFolders",{fileid:i,files:r}),o.forEach(s=>e.commit("addPath",{path:s.filename,fileid:s.fileid}))},addPath(e,{path:i,fileid:r}){e.commit("addPath",{path:i,fileid:r})},addFilesToFolder(e,{fileid:i,files:r}){e.commit("addFilesToFolder",{fileid:i,files:r})}},fe={state:U,mutations:A,getters:D,actions:R},B={name:"FolderTagPreview",components:{Folder:f},props:{icon:{type:String,default:"icon-folder"},id:{type:[Number,String],required:!0},name:{type:String,required:!0},path:{type:String,default:""},fileList:{type:Array,default:()=>[]},to:{type:Object,default:null}},data(){return{failed:[]}},computed:{isEmpty(){return this.previewList.length===0},ariaLabel(){return t("photos",'Open the "{name}" folder',{name:this.name})},previewList(){return this.fileList.filter(e=>this.failed.indexOf(e.fileid)===-1)},previewUrl(){if(this.previewList.length===0)return null;const{fileid:e,etag:i}=this.previewList.at(-1);return y(`/core/preview?fileId=${e}&c=${i}&x=250&y=250&forceIcon=0&a=0`)},toLink(){if(this.to)return this.to;const e=`/files/${p()?.uid}`;let i=this.path.replace(new RegExp(`^${e}`),"");return i=/^\/?(.+)/i.exec(i)[1],Object.assign({},this.$route,{params:{path:i.split("/")}})}},methods:{onPreviewFail({fileid:e}){this.failed.push(e)}}};var G=function(){var e=this,i=e._self._c;return i("router-link",{staticClass:"folder",attrs:{to:e.toLink,"aria-label":e.ariaLabel}},[e.previewUrl?i("img",{staticClass:"folder__image",attrs:{src:e.previewUrl,alt:""},on:{error:function(r){return e.onPreviewFail(e.file)}}}):i("span",{staticClass:"folder__image folder__image--placeholder"},[i("Folder",{staticClass:"folder__icon",attrs:{size:96,"fill-color":"var(--color-primary-element)"}})],1),i("span",{staticClass:"folder__details"},[i("Folder"),i("span",{staticClass:"folder__title"},[e._v(e._s(e.name))])],1)])},M=[],V=d(B,G,M,!1,null,"f97fb29d");const H=V.exports,J={name:"Folder",components:{FolderTagPreview:H},mixins:[u],inheritAttrs:!1,props:{item:{type:Object,required:!0}},data(){return{previewFolder:this.item.injected.fileid}},computed:{...c(["files","folders"]),folderContent(){return this.folders[this.item.injected.fileid]},previewFiles(){const e=this.folders[this.previewFolder],i=e?e.map(r=>this.files[r]).slice(0,4):[];if(i.length===0&&this.files[this.previewFolder].folders&&this.previewFolder===this.item.injected.fileid){const r=this.files[this.previewFolder].folders[0];this.updatePreviewFolder(r),this.folders[this.previewFolder]||this.getFolderData(this.files[this.previewFolder].filename)}return i}},async created(){this.folderContent||await this.getFolderData(this.item.injected.filename)},methods:{async getFolderData(e){try{const i=`/files/${p()?.uid}`,r=e.replace(new RegExp(`^${i}`),""),{folder:o,folders:s,files:l}=await m(r,{shared:this.item.injected.showShared,signal:this.abortController.signal});this.$store.dispatch("updateFolders",{fileid:o.fileid,files:l,folders:s}),this.$store.dispatch("updateFiles",{folder:o,files:l,folders:s})}catch(i){i.response&&i.response.status?n.error("Failed to get folder content",{error:i,filename:e}):n.debug(i)}},updatePreviewFolder(e){this.previewFolder=e}}};var K=function(){var e=this,i=e._self._c;return i("FolderTagPreview",{attrs:{id:e.item.injected.fileid,name:e.item.injected.basename.toString(),path:e.item.injected.filename,"file-list":e.previewFiles}})},Q=[],W=d(J,K,Q,!1,null,"d8a42b05");const X=W.exports,Y={name:"Folders",components:{FolderIcon:f,HeaderNavigation:P,NcEmptyContent:b,NcLoadingIcon:C,UploadPicker:_,VirtualGrid:w},mixins:[u,x],props:{rootTitle:{type:String,required:!0},path:{type:String,default:"/"},showShared:{type:Boolean,default:!1}},data(){return{error:null,allowedMimes:T,initializing:!0,loading:!1,appContent:document.getElementById("app-content-vue"),uploader:$()}},computed:{...c(["files","folders"]),folderId(){return this.$store.getters.folderId(this.path)},folder(){return this.files[this.folderId]},folderAsFolder(){return this.folder?new L({...this.folder,source:decodeURI(this.folder.source),permissions:I(this.folder.permissions)}):null},folderContent(){return this.folders[this.folderId]||[]},fileList(){return this.folderContent&&this.folderContent.map(e=>this.files[e]).filter(e=>!!e)},subFolders(){return this.folderId&&this.files[this.folderId]&&this.files[this.folderId].folders},folderList(){return this.subFolders&&this.subFolders.map(e=>this.files[e]).filter(e=>!!e)},contentList(){const e=this.folderList?.map(r=>({id:`folder-${r.fileid}`,injected:{...r,showShared:this.showShared},width:232,height:280,columnSpan:1,renderComponent:X})),i=this.fileList?.map(r=>({id:`file-${r.fileid}`,injected:{...r,list:this.fileList},width:256,height:256,columnSpan:1,renderComponent:E}));return[...e||[],...i||[]]},isEmpty(){return!this.haveFiles&&!this.haveFolders},haveFiles(){return!!this.fileList&&this.fileList.length!==0},haveFolders(){return!!this.folderList&&this.folderList.length!==0}},watch:{path(){this.fetchFolderContent()},showShared(){this.fetchFolderContent()}},beforeMount(){this.fetchFolderContent()},methods:{onRefresh(){this.fetchFolderContent()},async fetchFolderContent(){this.error=null,this.loading=!0,OCA?.Viewer?.close?.(),OCA?.Files?.Sidebar?.close?.(),(!this.files[this.folderId]||!this.folders[this.folderId])&&(this.initializing=!0);try{const{folder:e,folders:i,files:r}=await m(this.path,{shared:this.showShared,signal:this.abortController.signal});this.$store.dispatch("addPath",{path:this.path,fileid:e.fileid}),this.$store.dispatch("updateFolders",{fileid:e.fileid,files:r,folders:i}),this.$store.dispatch("updateFiles",{folder:e,files:r,folders:i})}catch(e){e.response&&e.response.status&&(e.response.status===404?(this.error=404,setTimeout(()=>{this.$router.push({name:this.$route.name})},3e3)):this.error=e),n.error("Error fetching album data",{error:e})}finally{this.loading=!1,this.initializing=!1}},async onUpload(e){const i=e.source.split(S).pop(),r=await N(i);this.$store.dispatch("appendFiles",[r]),this.$store.dispatch("addFilesToFolder",{fileid:this.folderId,files:[r]})}}};var Z=function(){var e=this,i=e._self._c;return e.error===404?i("NcEmptyContent",{attrs:{name:e.t("photos","This folder does not exist")},scopedSlots:e._u([{key:"icon",fn:function(){return[i("FolderIcon")]},proxy:!0}],null,!1,1472452094)}):e.error?i("NcEmptyContent",{attrs:{name:e.t("photos","An error occurred")}}):e.initializing?i("NcEmptyContent",{attrs:{name:e.t("photos","Loading folders â€¦")},scopedSlots:e._u([{key:"icon",fn:function(){return[i("NcLoadingIcon")]},proxy:!0}])}):e.initializing?e._e():i("div",[i("HeaderNavigation",{key:"navigation",class:{"photos-navigation--uploading":e.uploader.queue?.length>0},attrs:{loading:e.loading,path:e.path,title:e.folder?.basename?.toString?.()||e.rootTitle,"root-title":e.rootTitle},on:{refresh:e.onRefresh}},[i("UploadPicker",{attrs:{accept:e.allowedMimes,destination:e.folderAsFolder,multiple:!0},on:{uploaded:e.onUpload}})],1),e.isEmpty?i("NcEmptyContent",{key:"emptycontent",attrs:{name:e.t("photos","No photos in here")},scopedSlots:e._u([{key:"icon",fn:function(){return[i("FolderIcon")]},proxy:!0}],null,!1,1472452094)}):i("div",{staticClass:"grid-container",class:{"grid-container--folders":e.haveFolders}},[i("VirtualGrid",{ref:"virtualgrid",attrs:{items:e.contentList,"scroll-element":e.appContent,"get-column-count":()=>e.haveFolders?e.gridConfig.folderCount:e.gridConfig.count,"get-grid-gap":()=>e.haveFolders?16:8}})],1)],1)},ee=[],te=d(Y,Z,ee,!1,null,"32ac8dc5");const ie=te.exports,he=Object.freeze(Object.defineProperty({__proto__:null,default:ie},Symbol.toStringTag,{value:"Module"}));export{he as F,ne as P,fe as f};
//# sourceMappingURL=folders-D4009oow.chunk.mjs.map
