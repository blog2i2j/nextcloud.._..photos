import{d as c,O as F,H as d,t as o}from"./vue.runtime.esm-DZVHDHac.chunk.mjs";import{l as r,m as f,p as g,E as u,B as p,S as m}from"./index-CtBKWcPT.chunk.mjs";import{g as S}from"./PhotoSearch-BwtcAlrw.chunk.mjs";import{A as w}from"./AbortControllerMixin-BHckU111.chunk.mjs";const E=c({name:"FetchFilesMixin",mixins:[w],data(){return{errorFetchingFiles:null,loadingFiles:!1,doneFetchingFiles:!1,fetchSemaphore:new m(1),fetchedFileIds:[]}},watch:{"$route.path"(){this.resetFetchFilesState()}},methods:{async fetchFiles(l={},h=[],n=!1){if(this.doneFetchingFiles&&!n||this.loadingFiles)return[];const a=await this.fetchSemaphore.acquire();try{this.errorFetchingFiles=null,this.loadingFiles=!0;const e=200,s=await S({firstResult:this.fetchedFileIds.length,nbResults:e,...l,signal:this.abortController.signal});s.length!==e&&(this.doneFetchingFiles=!0);const t=s.map(i=>i.fileid).filter(i=>!this.fetchedFileIds.includes(i));return this.fetchedFileIds.push(...t.filter(i=>!h.includes(i))),this.$store.dispatch("appendFiles",s),r.debug(`[FetchFilesMixin] Fetched ${t.length} new files: `,{fileIds:t}),t}catch(e){if(f(e)&&e.response?.status===404){const s=g.state.userConfig.photosSourceFolders;for(const t of s)if(e.response?.data?.match(`File with name /${t} could not be located`)!==null){r.debug(`The ${t} folder does not exist, creating it.`);try{return await u.createDirectory(F(d,t)),this.resetFetchFilesState(),[]}catch(i){this.errorFetchingFiles=404,r.error("Fail to create source directory",{error:i})}}}else{if(e instanceof DOMException&&e.code===e.ABORT_ERR)return[];this.errorFetchingFiles=e}p(o("photos","Error fetching files")),r.error(o("photos","Error fetching files"),{error:e})}finally{this.loadingFiles=!1,this.fetchSemaphore.release(a)}return[]},resetFetchFilesState(){this.doneFetchingFiles=!1,this.errorFetchingFiles=null,this.loadingFiles=!1,this.fetchedFileIds=[]}}});export{E as F};
//# sourceMappingURL=FetchFilesMixin-BFmwx91D.chunk.mjs.map
